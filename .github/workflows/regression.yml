name: Regression Test Suite

on:
  workflow_dispatch:
    inputs:
      test_xml_file:
        description: 'Select the TestNG XML file to run'
        required: true
        type: choice
        options:
          - testng.xml
          - src/test/resources/testng.xml
      environment:
        description: 'Select Environment to run tests against'
        required: true
        type: choice
        options:
          - qa
          - stage
          - dev
        default: stage


jobs:
  regression-test:
    runs-on: ubuntu-latest
    permissions:
      contents: write


    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Run Regression Tests
        id: test_execution
        run: |
          mvn clean test \
            -DxmlFile=${{ github.event.inputs.test_xml_file }} \
            -Denvironment=${{ github.event.inputs.environment }} \
            -Dallure.results.directory=allure-results \
            || true

      - name: Checkout GitHub Pages branch
        uses: actions/checkout@v4
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Generate Allure Report
        uses: simple-elf/allure-report-action@master
        if: always()
        with:
          allure_results: allure-results
          allure_report: allure-report
          gh_pages: gh-pages
          allure_history: allure-history
          retention_period: 5

      - name: Upload Allure Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: allure-results

      - name: Deploy Allure report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: always()
        with:
          personal_token: ${{ secrets.GH_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history

      - name: Generate Test Report Data
        if: always()
        id: report_data
        run: |
          # Parse test results
          if [ -f "target/surefire-reports/testng-results.xml" ]; then
            TOTAL_TESTS=$(grep -o 'total="[0-9]*"' target/surefire-reports/testng-results.xml | head -1 | grep -o '[0-9]*' || echo "0")
            PASSED_TESTS=$(grep -o 'passed="[0-9]*"' target/surefire-reports/testng-results.xml | head -1 | grep -o '[0-9]*' || echo "0")
            FAILED_TESTS=$(grep -o 'failed="[0-9]*"' target/surefire-reports/testng-results.xml | head -1 | grep -o '[0-9]*' || echo "0")
            SKIPPED_TESTS=$(grep -o 'skipped="[0-9]*"' target/surefire-reports/testng-results.xml | head -1 | grep -o '[0-9]*' || echo "0")
          else
            TOTAL_TESTS="0"
            PASSED_TESTS="0"
            FAILED_TESTS="0"
            SKIPPED_TESTS="0"
          fi
          
          echo "TOTAL_TESTS=${TOTAL_TESTS}" >> $GITHUB_OUTPUT
          echo "PASSED_TESTS=${PASSED_TESTS}" >> $GITHUB_OUTPUT
          echo "FAILED_TESTS=${FAILED_TESTS}" >> $GITHUB_OUTPUT
          echo "SKIPPED_TESTS=${SKIPPED_TESTS}" >> $GITHUB_OUTPUT
          echo "RUN_DATE=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      - name: Prepare Email Template
        if: always()
        id: email_template
        run: |
          # Read template file
          TEMPLATE_FILE=".github/email-template.html"
          EMAIL_BODY=$(cat "$TEMPLATE_FILE")
          
          # Replace template variables with actual values
          EMAIL_BODY="${EMAIL_BODY//\{\{TEST_XML_FILE\}\}/${{ github.event.inputs.test_xml_file }}}"
          EMAIL_BODY="${EMAIL_BODY//\{\{RUN_DATE\}\}/${{ steps.report_data.outputs.RUN_DATE }}}"
          EMAIL_BODY="${EMAIL_BODY//\{\{REPOSITORY\}\}/${{ github.repository }}}"
          EMAIL_BODY="${EMAIL_BODY//\{\{BRANCH\}\}/${{ github.ref_name }}}"
          EMAIL_BODY="${EMAIL_BODY//\{\{COMMIT_SHA\}\}/${{ github.sha }}}"
          EMAIL_BODY="${EMAIL_BODY//\{\{TOTAL_TESTS\}\}/${{ steps.report_data.outputs.TOTAL_TESTS }}}"
          EMAIL_BODY="${EMAIL_BODY//\{\{PASSED_TESTS\}\}/${{ steps.report_data.outputs.PASSED_TESTS }}}"
          EMAIL_BODY="${EMAIL_BODY//\{\{FAILED_TESTS\}\}/${{ steps.report_data.outputs.FAILED_TESTS }}}"
          EMAIL_BODY="${EMAIL_BODY//\{\{SKIPPED_TESTS\}\}/${{ steps.report_data.outputs.SKIPPED_TESTS }}}"
          EMAIL_BODY="${EMAIL_BODY//\{\{WORKFLOW_URL\}\}/${{ github.server_url }}\/${{ github.repository }}\/actions\/runs\/${{ github.run_id }}}"
          EMAIL_BODY="${EMAIL_BODY//\{\{GITHUB_PAGES_URL\}\}/${{ github.server_url }}\/${{ github.repository }}\/deployments\/activity_log?environment=github-pages}"
          EMAIL_BODY="${EMAIL_BODY//\{\{ARTIFACTS_URL\}\}/${{ github.server_url }}\/${{ github.repository }}\/actions\/runs\/${{ github.run_id }}}"
          EMAIL_BODY="${EMAIL_BODY//\{\{REPO_URL\}\}/${{ github.server_url }}\/${{ github.repository }}}"
          
          # Save to temporary file
          echo "$EMAIL_BODY" > /tmp/email_body.html
          
          # Create output variable with file content
          echo "EMAIL_CONTENT<<EOF" >> $GITHUB_ENV
          cat /tmp/email_body.html >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Send Email Notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: suchetaghogare2@gmail.com
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: 'Regression Test Execution Report - ${{ github.event.inputs.test_xml_file }} (Env: ${{ github.event.inputs.environment }})'
          to: harshhpatel07@gmail.com
          from: suchetaghogare2@gmail.com
          html_body: true
          body: ${{ env.EMAIL_CONTENT }}
          attachments: /tmp/email_body.html

